#!/usr/bin/env python3

import csv
import json
from collections import OrderedDict
from datetime import datetime, timedelta
from subprocess import PIPE, Popen, run
from sys import argv
from time import localtime, sleep, strftime

import requests


def bg(cmd):
    return Popen(cmd, shell=True, stdout=PIPE)

def json2csv(j: list, w: csv.writer):
    if len(j) == 0:
        return
    w.writerow(j[0].keys())
    for r in j:
        w.writerow(r.values())

def capture(capturename):
    filename = capturename + '.json'
    samples = []
    starttime = datetime.now()
    try:
        while True:
            pm = bg('powermetrics -i 1000 -n 1')
            sleep(0.95)
            istat = requests.get('http://localhost:4027/api/')
            pm.wait()
            pm = [s for b in pm.stdout.readlines() if ':' in (s := b.decode('utf-8').rstrip())]
            pm = dict([[f.strip() for f in s.split(':', 1)] for s in pm])
            timestamp = datetime.now() - starttime
            samples.append({'timestamp': timestamp / timedelta(seconds=1),
                            'istatistica': json.loads(istat.text),
                            'powermetrics': pm})
    except KeyboardInterrupt:
        pass
    json.dump(samples, open(filename, 'w', encoding='utf-8'))
    return samples

def plot(samples, capturename: str):
    j = []
    fmt = '%S' if (l := samples[-1:][0]['timestamp']) < 60 else '%M:%S' if l < 3600 else '%H:%M:%S'
    for sample in samples:
        row = OrderedDict()
        istat = sample['istatistica']
        row['Time'] = strftime(fmt, localtime(sample['timestamp']))
        row['CPU (%)'] = int(istat['summary_cpuLoad'] * 100)
        row.update([(f'{k} (rpm)', v) for k,v in istat['fans'].items()])
        row.update([(f'{k} (â„ƒ)', v) for k,v in istat['sensors'].items()])
        row['Battery (%)'] = istat['battery_charge']
        row['Read (MB/s)'] = int(istat['diskIO_speedRead'] / 1000000)
        row['Write (MB/s)'] = int(istat['diskIO_speedWrite'] / 1000000)
        row['Recv (KB/s)'] = int(istat['network_speedDownload'] / 1000)
        row['Send (KB/s)'] = int(istat['network_speedUpload'] / 1000)
        row.update([(f'{x} (MB)', int(istat[f'summary_memory{x}'] / 1000000)) for x in ('Free', 'Inactive', 'Used', 'Wired', 'Other')])
        pm = sample['powermetrics']
        power = [(k.replace(' Power', ''), v.split(' ')) for k,v in pm.items() if ' Power' in k]
        row.update([(f'{n} ({v[1]})', v[0]) for n,v in power])
        cpus = [(k.replace(' frequency', ''), v.split(' ')) for k,v in pm.items() if ' frequency' in k]
        row.update([(f'{i} ({v[1]})', v[0]) for i,v in cpus])
        j.append(row)
    with open(capturename + '.csv', 'w', encoding='utf-8') as f:
        json2csv(j, csv.writer(f))
    run(f'open \'{capturename}.csv\'', check=True, shell=True)

if __name__ == '__main__':
    if len(argv) == 1:
        cap = datetime.now().strftime('%Y-%m-%d_%H-%M-%S')
        plot(capture(cap), cap)
    elif argv[1][0] == 'c':
        capture(datetime.now().strftime('%Y-%m-%d_%H-%M-%S'))
    elif argv[1][0] == 'p':
        with open(argv[2] + '.json', 'r', encoding='utf-8') as f:
            plot(json.load(f), argv[2])
    else:
        print('MacPlot by pixel <pixel@chrissx.de>')
        print('Usage:')
        print(f'  {argv[0]}: capture and plot in one command')
        print(f'  {argv[0]} c[apture]: capture data')
        print(f'  {argv[0]} p[lot] [cap]: prepare the data and open numbers for plotting')
